name: 手动运行咪咕720P频道抓取脚本

on:
  workflow_dispatch:
    inputs:
      output_filename:
        description: '输出文件的前缀名称（可选，默认 migu_720p）'
        required: false
        default: 'migu_720p'
        type: string

jobs:
  run-script:
    runs-on: ubuntu-latest
    # 增加超时时间（默认3600秒，避免脚本运行超时）
    timeout-minutes: 10
    
    steps:
      - name: 检出仓库代码
        uses: actions/checkout@v4
        # 确保完整检出仓库文件（解决文件匹配失败问题）
        with:
          fetch-depth: 1

      - name: 设置 Python 环境
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          # 修复：关闭pip缓存（因为无requirements.txt），或指定空缓存路径
          cache: ''  # 关键修复：禁用自动缓存，避免查找依赖文件失败

      # 优化：使用国内PyPI源加速依赖安装（解决海外环境下载慢）
      - name: 安装依赖包（国内源加速）
        run: |
          python -m pip install --upgrade pip -i https://pypi.tuna.tsinghua.edu.cn/simple
          pip install requests -i https://pypi.tuna.tsinghua.edu.cn/simple

      # 优化：增加国内DNS和超时配置（解决访问咪咕接口超时）
      - name: 执行咪咕720P频道抓取脚本
        run: |
          # 临时修改DNS为国内公共DNS，优化海外访问国内接口
          echo "nameserver 223.5.5.5" | sudo tee /etc/resolv.conf > /dev/null
          # 运行脚本，增加超时容错
          python main.py
        env:
          OUTPUT_FILENAME: ${{ github.event.inputs.output_filename }}
        # 增加步骤超时时间
        timeout-minutes: 8

      - name: 上传生成的频道文件
        uses: actions/upload-artifact@v4
        with:
          name: 咪咕720P频道文件
          path: |
            *.m3u
            *.txt
          retention-days: 7
        # 即使脚本部分失败，也尝试上传已生成的文件
        if: always()
